<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ™ºèƒ½æŠ å›¾å·¥å…·</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="/manifest.json">

    <!-- ç½‘ç«™å›¾æ ‡ -->
    <link rel="icon" type="image/png" href="static/icons/icon.png">
    <link rel="icon" type="image/svg+xml" href="static/icons/icon.svg">
    
    <!-- iOSå›¾æ ‡å’Œé…ç½® -->
    <link rel="apple-touch-icon" href="static/icons/icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="æŠ å›¾å·¥å…·">

    <!-- ä¸»é¢˜é¢œè‰² -->

</head>
<body>
    <div class="container">
        <div class="header">
            <h1>AIæ™ºèƒ½æŠ å›¾å·¥å…·</h1>
            <p>å¿«é€Ÿç§»é™¤å›¾ç‰‡èƒŒæ™¯ï¼Œç”Ÿæˆé€æ˜èƒŒæ™¯å›¾ç‰‡</p>
        </div>

        <div class="upload-section">
            <input type="file" id="batch-upload" accept="image/*" multiple hidden>
            <button class="upload-button" onclick="document.getElementById('batch-upload').click()">
                <span class="button-icon">ğŸ“‚</span>
                <span>é€‰æ‹©å›¾ç‰‡</span>
            </button>
            <p class="upload-hint">æ”¯æŒå•å¼ æˆ–å¤šå¼  JPGã€PNG æ ¼å¼å›¾ç‰‡</p>
        </div>

        <div class="images-preview hidden">
            <h3>å¾…å¤„ç†å›¾ç‰‡</h3>
            <div class="images-container">
                <button class="scroll-button scroll-left" onclick="scrollImages('left')">â†</button>
                <button class="scroll-button scroll-right" onclick="scrollImages('right')">â†’</button>
                <div class="images-list"></div>
            </div>
            <div class="scroll-indicator"></div>
        </div>

      

        <div class="control-panel">
            <div class="control-group">
                <label>æŠ å›¾æ¨¡å¼</label>
                <div class="select-controls">
                    <select id="alpha-matting" class="control-select" onchange="toggleParamsPanel()" aria-label="æŠ å›¾æ¨¡å¼é€‰æ‹©">
                        <option value="false">æ™®é€šæ¨¡å¼</option>
                        <option value="true">ç²¾ç»†æ¨¡å¼</option>
                        <option value="color">é¢œè‰²æŠ å›¾</option>
                    </select>
                    <select id="only-mask" class="control-select" aria-label="è¾“å‡ºæ¨¡å¼é€‰æ‹©">
                        <option value="false">å®Œæ•´å›¾ç‰‡</option>
                        <option value="true">ä»…è’™ç‰ˆ</option>
                    </select>
                </div>
            </div>
            <div class="control-group" id="params-panel">
                <label>å‚æ•°è°ƒèŠ‚</label>
                <div class="slider-group">
                    <div class="slider-label">
                        <label>å‰æ™¯é˜ˆå€¼</label>
                        <span id="threshold-value">230</span>
                    </div>
                    <input type="range" id="alpha-matting-foreground-threshold" 
                           min="1" max="255" value="230" class="control-range"
                           aria-label="å‰æ™¯é˜ˆå€¼è°ƒèŠ‚" title="å‰æ™¯é˜ˆå€¼è°ƒèŠ‚">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <label>èƒŒæ™¯é˜ˆå€¼</label>
                        <span id="bg-threshold-value">20</span>
                    </div>
                    <input type="range" id="alpha-matting-background-threshold" 
                           min="1" max="255" value="20" class="control-range"
                           aria-label="èƒŒæ™¯é˜ˆå€¼è°ƒèŠ‚" title="èƒŒæ™¯é˜ˆå€¼è°ƒèŠ‚">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <label>è¾¹ç¼˜æ¨¡ç³Š</label>
                        <span id="blur-value">3</span>
                    </div>
                    <input type="range" id="edge-blur" 
                           min="0" max="100" value="3" class="control-range"
                           aria-label="è¾¹ç¼˜æ¨¡ç³Šè°ƒèŠ‚" title="è¾¹ç¼˜æ¨¡ç³Šè°ƒèŠ‚">
                </div>
            </div>
            <div class="control-group">
                <label>èƒŒæ™¯è®¾ç½®</label>
                <div class="background-controls">
                    <select id="background-type" class="control-select" onchange="toggleBackgroundColor()" aria-label="èƒŒæ™¯ç±»å‹é€‰æ‹©" title="èƒŒæ™¯ç±»å‹é€‰æ‹©">
                        <option value="transparent">é€æ˜èƒŒæ™¯</option>
                        <option value="color">çº¯è‰²èƒŒæ™¯</option>
                    </select>
                    <input type="color" id="background-color" class="hidden" value="#ffffff" aria-label="èƒŒæ™¯é¢œè‰²é€‰æ‹©" title="èƒŒæ™¯é¢œè‰²é€‰æ‹©">
                </div>
            </div>
            <div class="control-group" id="color-matting-panel" >
                <label>é¢œè‰²æŠ å›¾è®¾ç½®</label>
                <div class="color-matting-controls">
                    <input type="color" id="target-color" value="#ffffff" title="é€‰æ‹©è¦æŠ é™¤çš„é¢œè‰²">
                    <div class="slider-group">
                        <div class="slider-label">
                            <label>é¢œè‰²å®¹å·®</label>
                            <span id="color-threshold-value">30</span>
                        </div>
                        <input type="range" id="color-threshold" 
                               min="0" max="100" value="30" class="control-range"
                               aria-label="é¢œè‰²å®¹å·®è°ƒèŠ‚" title="é¢œè‰²å®¹å·®è°ƒèŠ‚">
                    </div>
                </div>
            </div>
        </div>
        
        
        <div class="controls">
            <button id="process" class="action-button hidden">å¼€å§‹æŠ å›¾</button>
        </div>

        <div class="progress-container hidden">
            <div class="progress-info">
                <span class="progress-text">å¤„ç†è¿›åº¦ï¼š</span>
                <span class="progress-percentage">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress"></div>
            </div>
        </div>

        <div class="batch-results hidden">
            <h3>å¤„ç†ç»“æœ</h3>
            <div class="results-grid"></div>
        </div>
    </div>

    <!-- æ·»åŠ å¯†ç è¾“å…¥æ¨¡æ€æ¡† -->
    <div id="password-modal" class="password-modal">
        <div class="password-form">
            <h2>è¯·è¾“å…¥è®¿é—®å¯†ç </h2>
            <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ">
            <button onclick="verifyPassword()">ç¡®è®¤</button>
        </div>
    </div>

    <script>
        let envConfig = {
            devMode: false,
            enableAuth: true
        };

        // è·å–ç¯å¢ƒé…ç½®çš„å‡½æ•°
        async function getEnvConfig() {
            try {
                const response = await fetch('/get-env-config');
                envConfig = await response.json();
                console.log('Environment config loaded:', envConfig);
            } catch (error) {
                console.error('Failed to get environment config:', error);
            }
        }

        // ç¡®ä¿åœ¨é¡µé¢åŠ è½½æ—¶é¦–å…ˆè·å–ç¯å¢ƒé…ç½®
        document.addEventListener('DOMContentLoaded', async function() {
            // é¦–å…ˆè·å–ç¯å¢ƒé…ç½®
            await getEnvConfig();
            
            // ç„¶åå†æ£€æŸ¥è®¤è¯çŠ¶æ€
            checkAuth();
            
            // æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡è®¤è¯çŠ¶æ€
            setInterval(checkAuth, 5 * 60 * 1000);
            
            // ä¿®æ”¹å¯†ç è¾“å…¥æ¡†çš„å›è½¦é”®ç›‘å¬
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    verifyPassword();
                }
            });
            
            // å‰æ™¯é˜ˆå€¼æ»‘åŠ¨æ¡
            const foregroundSlider = document.getElementById('alpha-matting-foreground-threshold');
            const foregroundValue = document.getElementById('threshold-value');
            if(foregroundSlider && foregroundValue) {
                foregroundSlider.addEventListener('input', function() {
                    foregroundValue.textContent = this.value;
                });
            }

            // èƒŒæ™¯é˜ˆå€¼æ»‘åŠ¨æ¡
            const backgroundSlider = document.getElementById('alpha-matting-background-threshold');
            const backgroundValue = document.getElementById('bg-threshold-value');
            if(backgroundSlider && backgroundValue) {
                backgroundSlider.addEventListener('input', function() {
                    backgroundValue.textContent = this.value;
                });
            }

            // è¾¹ç¼˜æ¨¡ç³Šæ»‘åŠ¨æ¡
            const blurSlider = document.getElementById('edge-blur');
            const blurValue = document.getElementById('blur-value');
            if(blurSlider && blurValue) {
                blurSlider.addEventListener('input', function() {
                    blurValue.textContent = this.value;
                });
            }

            // é¢œè‰²å®¹å·®æ»‘åŠ¨æ¡
            const colorThresholdSlider = document.getElementById('color-threshold');
            const colorThresholdValue = document.getElementById('color-threshold-value');
            if(colorThresholdSlider && colorThresholdValue) {
                colorThresholdSlider.addEventListener('input', function() {
                    colorThresholdValue.textContent = this.value;
                });
            }
        });

        const image = document.getElementById('image');
        const preview = document.getElementById('preview');
        const processButton = document.getElementById('process');
        const loading = document.querySelector('.loading');

        let images = [];

        // æ·»åŠ æ»šåŠ¨å‡½æ•°
        function scrollImages(direction) {
            const list = document.querySelector('.images-list');
            const scrollAmount = 300; // æ¯æ¬¡æ»šåŠ¨çš„è·ç¦»
            
            if (direction === 'left') {
                list.scrollBy({
                    left: -scrollAmount,
                    behavior: 'smooth'
                });
            } else {
                list.scrollBy({
                    left: scrollAmount,
                    behavior: 'smooth'
                });
            }
            
            // æ›´æ–°æ»šåŠ¨æŒ‰é’®çŠ¶æ€
            setTimeout(updateScrollButtonsVisibility, 300);
        }

        // ä¿®æ”¹æ–‡ä»¶ä¸Šä¼ å¤„ç†å‡½æ•°
        function handleFileUpload(files) {
            const imagesList = document.querySelector('.images-list');
            const previewSection = document.querySelector('.images-preview');
            const processButton = document.getElementById('process');
            
            if (!imagesList || !previewSection) return;
            
            previewSection.style.display = 'block';
            imagesList.innerHTML = '';
            images = [];
            
            // é»˜è®¤éšè—å¤„ç†æŒ‰é’®
            processButton.style.display = 'none';
            
            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'image-item';
                    div.dataset.index = index;
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="é¢„è§ˆå›¾ç‰‡">
                        <div class="image-controls">
                            <button onclick="handleImageTransform(${index}, 'rotateLeft')">
                                <span>â†º</span> å‘å·¦æ—‹è½¬
                            </button>
                            <button onclick="handleImageTransform(${index}, 'rotateRight')">
                                <span>â†»</span> å‘å³æ—‹è½¬
                            </button>
                            <button onclick="handleImageTransform(${index}, 'flipH')">
                                <span>â†”</span> æ°´å¹³ç¿»è½¬
                            </button>
                            <button onclick="handleImageTransform(${index}, 'flipV')">
                                <span>â†•</span> å‚ç›´ç¿»è½¬
                            </button>
                            <button onclick="deleteImage(${index})" class="delete-button">
                                <span>ğŸ—‘ï¸</span> åˆ é™¤
                            </button>
                        </div>
                    `;
                    imagesList.appendChild(div);
                    
                    images[index] = {
                        file: file,
                        src: e.target.result,
                        transforms: [],
                        currentSrc: e.target.result
                    };

                    // å½“æœ‰å›¾ç‰‡æ—¶æ˜¾ç¤ºå¤„ç†æŒ‰é’®
                    if (images.length > 0) {
                        processButton.style.display = 'inline-block';
                        processButton.textContent = 'å¼€å§‹æŠ å›¾';
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        // ä¿®æ”¹åˆ é™¤å›¾ç‰‡å‡½æ•°
        function deleteImage(index) {
            const imageItem = document.querySelector(`.image-item[data-index="${index}"]`);
            const processButton = document.getElementById('process');
            
            if (imageItem) {
                imageItem.remove();
                images[index] = null;
                
                // é‡æ–°æ•´ç†imagesæ•°ç»„
                images = images.filter(img => img !== null);
                
                // æ›´æ–°æ‰€æœ‰å›¾ç‰‡çš„ç´¢å¼•
                document.querySelectorAll('.image-item').forEach((item, newIndex) => {
                    item.dataset.index = newIndex;
                    
                    // æ›´æ–°æŒ‰é’®çš„onclickäº‹ä»¶
                    const buttons = item.querySelectorAll('button');
                    buttons[0].setAttribute('onclick', `handleImageTransform(${newIndex}, 'rotateLeft')`);
                    buttons[1].setAttribute('onclick', `handleImageTransform(${newIndex}, 'rotateRight')`);
                    buttons[2].setAttribute('onclick', `handleImageTransform(${newIndex}, 'flipH')`);
                    buttons[3].setAttribute('onclick', `handleImageTransform(${newIndex}, 'flipV')`);
                    buttons[4].setAttribute('onclick', `deleteImage(${newIndex})`);
                });
                
                // å¦‚æœæ²¡æœ‰å›¾ç‰‡äº†ï¼Œéšè—å¤„ç†æŒ‰é’®å’Œé¢„è§ˆåŒºåŸŸ
                if (images.length === 0) {
                    processButton.style.display = 'none';
                    document.querySelector('.images-preview').style.display = 'none';
                }
                
                updateScrollButtonsVisibility();
            }
        }

        // æ›´æ–°æ»šåŠ¨æŒ‰é’®å¯è§
        function updateScrollButtonsVisibility() {
            const list = document.querySelector('.images-list');
            const leftButton = document.querySelector('.scroll-left');
            const rightButton = document.querySelector('.scroll-right');
            
            if (!list || !leftButton || !rightButton) return;
            
            const hasOverflow = list.scrollWidth > list.clientWidth;
            const atStart = list.scrollLeft <= 0;
            const atEnd = list.scrollLeft >= (list.scrollWidth - list.clientWidth);

            leftButton.style.display = hasOverflow && !atStart ? 'flex' : 'none';
            rightButton.style.display = hasOverflow && !atEnd ? 'flex' : 'none';
        }

        // ç›‘å¬æ»šåŠ¨äº‹ä»¶
        document.querySelector('.images-list').addEventListener('scroll', updateScrollButtonsVisibility);
        window.addEventListener('resize', updateScrollButtonsVisibility);

        // æ·»åŠ æ–‡ä»¶ä¸Šä¼ ç›‘å¬å™¨
        document.getElementById('batch-upload').addEventListener('change', (event) => {
            handleFileUpload(event.target.files);
        });

        // å›¾ç‰‡å˜æ¢å¤„ç†
        function handleImageTransform(index, action) {
            const img = document.querySelector(`.image-item[data-index="${index}"] img`);
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            
            switch(action) {
                case 'rotateLeft':
                case 'rotateRight':
                    const angle = action === 'rotateLeft' ? -90 : 90;
                    canvas.width = img.naturalHeight;
                    canvas.height = img.naturalWidth;
                    ctx.translate(canvas.width/2, canvas.height/2);
                    ctx.rotate(angle * Math.PI/180);
                    ctx.drawImage(img, -img.naturalWidth/2, -img.naturalHeight/2);
                    images[index].transforms.push({type: 'rotate', value: angle});
                    break;
                case 'flipH':
                case 'flipV':
                    if (action === 'flipH') {
                        ctx.scale(-1, 1);
                        ctx.drawImage(img, -canvas.width, 0);
                    } else {
                        ctx.scale(1, -1);
                        ctx.drawImage(img, 0, -canvas.height);
                    }
                    images[index].transforms.push({type: 'flip', value: action === 'flipH' ? 'horizontal' : 'vertical'});
                    break;
            }
            
            // æ›´æ–°å½“å‰å›¾ç‰‡æº
            const newImageData = canvas.toDataURL();
            images[index].currentSrc = newImageData;
            img.src = newImageData;
        }

        // æ·»åŠ ç»“æœæ˜¾ç¤ºå‡½æ•°
        function addToResults(url, index) {
            const resultsContainer = document.querySelector('.batch-results');
            const resultsGrid = document.querySelector('.results-grid');
            
            if (!resultsContainer || !resultsGrid) return;
            
            resultsContainer.style.display = 'block';
            
            const resultItem = document.createElement('div');
            resultItem.className = 'result-item';
            resultItem.innerHTML = `
                <img src="${url}" alt="å¤„ç†ç»“æœ ${index + 1}">
                <div class="result-controls">
                    <a href="${url}" download="result_${index + 1}.png" class="download-button">
                        ä¸‹è½½å›¾ç‰‡
                    </a>
                </div>
            `;
            
            resultsGrid.appendChild(resultItem);
        }

        // æ·»åŠ è¿›åº¦æ¡æ§åˆ¶å‡½æ•°
        const progressControl = {
            container: document.querySelector('.progress-container'),
            bar: document.querySelector('.progress'),
            text: document.querySelector('.progress-percentage'),
            
            // æ˜¾ç¤ºè¿›åº¦æ¡
            show() {
                this.container.classList.remove('hidden');
                this.reset();
            },
            
            // éšè—è¿›åº¦æ¡
            hide() {
                this.container.classList.add('hidden');
            },
            
            // é‡ç½®è¿›åº¦æ¡
            reset() {
                this.bar.style.width = '0%';
                this.text.textContent = '0%';
            },
            
            // æ›´æ–°è¿›åº¦
            update(progress) {
                const percentage = Math.min(100, Math.max(0, progress));
                this.bar.style.width = `${percentage}%`;
                this.text.textContent = percentage === 100 ? 'å®Œæˆ' : `${percentage}%`;
            },
            
            // å®Œæˆå¤„ç†
            complete() {
                this.update(100);
                setTimeout(() => {
                    this.hide();
                    this.reset();
                }, 2000);
            }
        };

        // ä¿®æ”¹å¤„ç†æŒ‰é’®äº‹ä»¶
        processButton.addEventListener('click', async () => {
            try {
                // ç¡®ä¿envConfigå·²ç»åˆå§‹åŒ–
                if (typeof envConfig === 'undefined') {
                    await getEnvConfig();
                }

                const progressContainer = document.querySelector('.progress-container');
                const progressBar = document.querySelector('.progress');
                const progressText = document.querySelector('.progress-percentage');
                const resultsGrid = document.querySelector('.results-grid');

                // é‡ç½®è¿›åº¦æ¡å’Œç»“æœåŒºåŸŸ
                progressBar.style.width = '0%';
                progressText.textContent = '0%';
                progressContainer.classList.remove('hidden');
                resultsGrid.innerHTML = '';  // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
                
                progressControl.show();
                processButton.disabled = true;
                processButton.textContent = 'å¤„ç†ä¸­...';

                // åªåœ¨å¯ç”¨è®¤è¯æ—¶æ£€æŸ¥è®¤è¯çŠ¶æ€
                if (envConfig.enableAuth) {
                    const authResponse = await fetch('/check-auth', {
                        method: 'GET',
                        credentials: 'include'
                    });
                    
                    if (!authResponse.ok) {
                        alert('è¯·å…ˆè¾“å…¥è®¿é—®å¯†ç ');
                        document.getElementById('password-modal').style.display = 'flex';
                        return;
                    }
                }

                for (let i = 0; i < images.length; i++) {
                    try {
                        const formData = new FormData();
                        // ä½¿ç”¨å˜æ¢åçš„å›¾ç‰‡æ•°æ®è€Œä¸æ˜¯åŸå§‹å›¾ç‰‡
                        const blob = await fetch(images[i].currentSrc).then(r => r.blob());
                        formData.append('file', blob);
                        formData.append('alpha_matting', document.getElementById('alpha-matting').value);
                        formData.append('alpha_matting_foreground_threshold', 
                            document.getElementById('alpha-matting-foreground-threshold').value);
                        formData.append('alpha_matting_background_threshold',
                            document.getElementById('alpha-matting-background-threshold').value);
                        formData.append('edge_blur', document.getElementById('edge-blur').value);
                        formData.append('only_mask', document.getElementById('only-mask').value);
                        formData.append('background_type', document.getElementById('background-type').value);
                        formData.append('background_color', document.getElementById('background-color').value);
                        formData.append('matting_mode', document.getElementById('alpha-matting').value);
                        formData.append('target_color', document.getElementById('target-color').value);
                        formData.append('color_threshold', document.getElementById('color-threshold').value);
                        
                        const response = await fetch('/remove-bg', {
                            method: 'POST',
                            body: formData,
                            credentials: 'include'
                        });
                        
                        const data = await response.blob();
                        const url = URL.createObjectURL(data);
                        
                        // æ›´æ–°è¿›åº¦
                        const progress = ((i + 1) / images.length * 100).toFixed(0);
                        progressControl.update(parseInt(progress));
                        
                        // æ˜¾ç¤ºç»“æœ
                        addToResults(url, i);
                        
                    } catch (error) {
                        console.error(`å¤„ç†ç¬¬${i + 1}å¼ å›¾ç‰‡å¤±è´¥:`, error);
                    }
                }
                
                // å¤„ç†å®Œæˆ
                progressControl.complete();
                processButton.disabled = false;
                processButton.textContent = 'å¼€å§‹å¤„ç†';

            } catch (error) {
                console.error('Error:', error);
                alert('å¤„ç†å¤±è´¥ï¼š' + error.message);
                
                // å‘ç”Ÿé”™è¯¯æ—¶é‡ç½®çŠ¶æ€
                processButton.disabled = false;
                processButton.textContent = 'å¼€å§‹å¤„ç†';
                progressControl.hide();
            }
        });

        function toggleParamsPanel() {
            const mode = document.getElementById('alpha-matting').value;
            const paramsPanel = document.getElementById('params-panel');
            const colorMattingPanel = document.getElementById('color-matting-panel');
            
            if (mode === 'true') {
                paramsPanel.style.display = 'block';
                colorMattingPanel.style.display = 'none';
            } else if (mode === 'color') {
                paramsPanel.style.display = 'none';
                colorMattingPanel.style.display = 'block';
            } else {
                paramsPanel.style.display = 'none';
                colorMattingPanel.style.display = 'none';
            }
        }

        // æ‰¹é‡å¤„ç†ç›¸å…³
        let batchImages = [];

        document.getElementById('batch-upload').addEventListener('change', (event) => {
            const files = Array.from(event.target.files);
            if (files.length > 0) {
                document.querySelector('.batch-preview').style.display = 'block';
                const batchList = document.querySelector('.batch-list');
                const scrollIndicator = document.querySelector('.scroll-indicator');
                batchList.innerHTML = '';
                scrollIndicator.innerHTML = '';
                
                files.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const div = document.createElement('div');
                        div.className = 'batch-item';
                        div.dataset.index = index;
                        div.innerHTML = `
                            <img src="${e.target.result}" alt="é¢„è§ˆå›¾ç‰‡">
                            <div class="batch-item-controls">
                                <button onclick="handleBatchImage(${index}, 'rotateLeft')">å‘å·¦æ—‹è½¬</button>
                                <button onclick="handleBatchImage(${index}, 'rotateRight')">å‘å³æ—‹è½¬</button>
                                <button onclick="handleBatchImage(${index}, 'flipH')">æ°´å¹³ç¿»è½¬</button>
                                <button onclick="handleBatchImage(${index}, 'flipV')">å‚ç›´ç¿»è½¬</button>
                            </div>
                        `;
                        batchList.appendChild(div);
                        
                        const dot = document.createElement('div');
                        dot.className = 'scroll-dot' + (index === 0 ? ' active' : '');
                        scrollIndicator.appendChild(dot);
                        
                        batchImages[index] = {
                            file: file,
                            src: e.target.result,
                            transforms: []
                        };
                    };
                    reader.readAsDataURL(file);
                });
                
                processButton.style.display = 'inline-block';
                processButton.textContent = 'å¼€å§‹å¤„ç†';
            }
        });

        function handleBatchImage(index, action) {
            const img = document.querySelector(`.batch-item[data-index="${index}"] img`);
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            
            switch(action) {
                case 'rotateLeft':
            canvas.width = img.naturalHeight;
            canvas.height = img.naturalWidth;
            ctx.translate(canvas.width/2, canvas.height/2);
                    ctx.rotate(-90 * Math.PI/180);
            ctx.drawImage(img, -img.naturalWidth/2, -img.naturalHeight/2);
                    batchImages[index].transforms.push({type: 'rotate', value: -90});
                    break;
                case 'rotateRight':
                    canvas.width = img.naturalHeight;
                    canvas.height = img.naturalWidth;
                    ctx.translate(canvas.width/2, canvas.height/2);
                    ctx.rotate(90 * Math.PI/180);
                    ctx.drawImage(img, -img.naturalWidth/2, -img.naturalHeight/2);
                    batchImages[index].transforms.push({type: 'rotate', value: 90});
                    break;
                case 'flipH':
                ctx.scale(-1, 1);
                ctx.drawImage(img, -canvas.width, 0);
                    batchImages[index].transforms.push({type: 'flip', value: 'horizontal'});
                    break;
                case 'flipV':
                ctx.scale(1, -1);
                ctx.drawImage(img, 0, -canvas.height);
                    batchImages[index].transforms.push({type: 'flip', value: 'vertical'});
                    break;
            }
            
            img.src = canvas.toDataURL();
        }

        const scrollLeft = document.querySelector('.scroll-left');
        const scrollRight = document.querySelector('.scroll-right');
        const batchList = document.querySelector('.batch-list');

        scrollLeft.addEventListener('click', () => {
            batchList.scrollBy({
                left: -300,
                behavior: 'smooth'
            });
        });

        scrollRight.addEventListener('click', () => {
            batchList.scrollBy({
                left: 300,
                behavior: 'smooth'
            });
        });

        batchList.addEventListener('scroll', () => {
            const items = document.querySelectorAll('.batch-item');
            const dots = document.querySelectorAll('.scroll-dot');
            const scrollPosition = batchList.scrollLeft;
            const itemWidth = items[0]?.offsetWidth || 0;
            
            const activeIndex = Math.round(scrollPosition / itemWidth);
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === activeIndex);
            });
        });

        // åˆå§‹åŒ–æ—¶è®¾ç½®å‚æ•°é¢æ¿çŠ¶æ€
        toggleParamsPanel();

        // ä¿®æ”¹æ£€æŸ¥è®¤è¯çŠ¶æ€çš„å‡½æ•°
        async function checkAuth() {
            try {
                console.log('Checking authentication...');
                // å…ˆè·å–ç¯å¢ƒé…ç½®
                await getEnvConfig();
                
                // å¦‚æœè®¤è¯ç¦ç”¨ç›´æ¥éšè—å¯†ç æ¡†
                if (!envConfig.enableAuth) {
                    console.log('Authentication is disabled');
                    const passwordModal = document.getElementById('password-modal');
                    passwordModal.style.display = 'none';
                    return;
                }

                const response = await fetch('/check-auth', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const result = await response.json();
                console.log('Auth check result:', result);
                
                const passwordModal = document.getElementById('password-modal');
                if (response.ok) {
                    console.log('Authentication successful');
                    passwordModal.style.display = 'none';
                } else {
                    console.log('Authentication failed');
                    passwordModal.style.display = 'flex';
                }
            } catch (error) {
                console.error('Auth check error:', error);
                // å‡ºé”™æ—¶ä¹Ÿè¦æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†è®¤è¯
                if (envConfig.enableAuth) {
                    document.getElementById('password-modal').style.display = 'flex';
                }
            }
        }

        // æ·»åŠ å¯†ç å“ˆå¸Œå‡½æ•°
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // ä¿®æ”¹å¯†ç è®¤è¯å‡½æ•°
        async function verifyPassword() {
            const password = document.getElementById('password').value;
            if (!password) {
                alert('è¯·è¾“å…¥å¯†ç ');
                return;
            }

            try {
                let password_hash;
                
                // è·å–ç¯å¢ƒé…ç½®
                await getEnvConfig();
                
                if (envConfig.devMode) {
                    // å¼€å‘ç¯å¢ƒï¼šä½¿ç”¨æ˜æ–‡å¯†ç 
                    password_hash = password;
                } else {
                    // ç”Ÿäº§ç¯å¢ƒï¼šå¿…é¡»ä½¿ç”¨å“ˆå¸Œ
                    try {
                        password_hash = await sha256(password);
                    } catch (error) {
                        console.error('Hashing failed:', error);
                        alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåŠ å¯†åŠŸèƒ½ï¼Œæ— æ³•åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ä½¿ç”¨');
                        return;
                    }
                }

                const response = await fetch('/verify-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password_hash }),
                    credentials: 'include'
                });

                const data = await response.json();
                if (data.status === 'success') {
                    document.querySelector('.password-modal').style.display = 'none';
                    checkAuth();  // æ›´æ–°è®¤è¯çŠ¶æ€
                } else {
                    alert('å¯†ç é”™è¯¯');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('éªŒè¯å¤±è´¥');
            }
        }

        function toggleBackgroundColor() {
            const backgroundType = document.getElementById('background-type').value;
            const backgroundColorInput = document.getElementById('background-color');
            backgroundColorInput.style.display = backgroundType === 'color' ? 'inline-block' : 'none';
        }

        // æ·»åŠ  sha256 å‡½æ•°å®šä¹‰
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
    </script>
</body>
</html>

